<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Over - Victory!</title>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    <style>
        :root {
            --primary-green: #2E7D32;
            --ocean-blue: #4A90E2;
            --sand-beige: #F4E4BC;
            --parchment: #FDF6E3;
            --coral: #FF6F61;
            --dark-coral: #E55A50;
            --teal: #26A69A;
            --success-green: #4CAF50;
            --shadow: rgba(0, 0, 0, 0.2);
            --text-dark: #333;
            --text-light: #666;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, var(--sand-beige) 100%);
            color: var(--text-dark);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-in;
        }

        .modal-content {
            background: linear-gradient(145deg, var(--parchment), #FFF8E1);
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 80%;
            text-align: center;
            box-shadow: 0 6px 12px var(--shadow);
            border: 3px solid var(--primary-green);
        }

        .modal-content h1 {
            color: var(--success-green);
            font-size: 2em;
            margin: 0.5em 0;
            font-weight: 700;
            text-shadow: 1px 1px 2px var(--shadow);
        }

        .modal-content p {
            color: var(--text-dark);
            font-size: 1.1em;
            line-height: 1.5;
            margin: 10px 0;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
            background: #fff;
        }

        .modal-content button {
            padding: 12px 24px;
            font-size: 1.2em;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--coral), var(--dark-coral));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            margin: 10px;
            box-shadow: 0 4px 8px var(--shadow);
        }

        .modal-content button:hover {
            background: linear-gradient(135deg, var(--dark-coral), var(--coral));
            transform: translateY(-2px);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-green);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow);
            z-index: 2000;
            font-size: 1em;
            animation: fadeIn 0.3s ease-in, fadeOut 0.3s ease-out 2.7s forwards;
        }

        .toast.error {
            background: var(--dark-coral);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @media (max-width: 600px) {
            .modal-content {
                width: 90%;
                padding: 15px;
            }

            .modal-content h1 {
                font-size: 1.8em;
            }

            .modal-content p {
                font-size: 1em;
            }

            .modal-content input[type="text"] {
                font-size: 0.9em;
                padding: 8px;
            }

            .modal-content button {
                font-size: 1em;
                padding: 10px 20px;
            }

            .toast {
                font-size: 0.9em;
                padding: 8px 16px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="end-modal" class="modal">
        <div class="modal-content">
            <h1>Victory! You Escaped the Island!</h1>
            <p>Congratulations! You solved the radio code, unlocked the bullets, and fired the flare. The rescue chopper spotted your signal and safely extracted you just as the plane exploded in the distance. You're a true survivor!</p>
            <div id="name-submission">
                <p>Submit your name to record your win!</p>
                <input type="text" id="player-name" placeholder="Enter your name" aria-label="Player name">
                <button id="submit-name-btn">Submit Name</button>
            </div>
            <button id="play-again-btn">Play Again</button>
        </div>
    </div>

    <script>
        (function () {
            // Initialize EmailJS
            emailjs.init('iPjziLz6-ui5TluiZ');

            const playAgainBtn = document.getElementById('play-again-btn');
            const submitNameBtn = document.getElementById('submit-name-btn');
            const playerNameInput = document.getElementById('player-name');
            const nameSubmissionDiv = document.getElementById('name-submission');
            const endModal = document.getElementById('end-modal');

            if (!playAgainBtn || !submitNameBtn || !playerNameInput || !nameSubmissionDiv || !endModal) {
                console.error('One or more DOM elements are missing. Please check the HTML structure.');
                return;
            }

            // Check if name has already been submitted (stored in localStorage)
            let isNameSubmitted = localStorage.getItem('nameSubmitted') === 'true';

            // Hide name submission elements if already submitted
            if (isNameSubmitted) {
                nameSubmissionDiv.style.display = 'none';
            }

            function showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `toast ${isError ? 'error' : ''}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            function submitName() {
                const playerName = playerNameInput.value.trim();
                if (!playerName) {
                    showToast('Please enter a name.', true);
                    return;
                }

                emailjs.send('service_637q56m', 'template_9hu2bkl', {
                    message: `New winner: ${playerName}`,
                    from_email: 'jacobfazer1@gmail.com',
                    to_email: 'jacobfazer1@gmail.com'
                })
                    .then(() => {
                        showToast('Name submitted successfully!');
                        playerNameInput.value = '';
                        isNameSubmitted = true;
                        localStorage.setItem('nameSubmitted', 'true');
                        nameSubmissionDiv.style.display = 'none';
                    }, (error) => {
                        showToast('Failed to submit name.', true);
                        console.error('EmailJS error:', error);
                    });
            }

            function restartGame() {
                localStorage.removeItem('nameSubmitted'); // Reset submission state on restart
                window.location.href = 'index.html';
            }

            submitNameBtn.addEventListener('click', () => {
                try {
                    if (!isNameSubmitted) {
                        submitName();
                    }
                } catch (error) {
                    console.error('Error in submit name action:', error);
                    showToast('An error occurred.', true);
                }
            });

            playAgainBtn.addEventListener('click', () => {
                try {
                    restartGame();
                } catch (error) {
                    console.error('Error in restart action:', error);
                    showToast('An error occurred.', true);
                }
            });
        })();
    </script>
</body>
</html>
